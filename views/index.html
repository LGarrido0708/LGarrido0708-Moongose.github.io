<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <title>Item</title>
</head>

<body>
    <center>
        <div id="container" class="container">
            <h2>List of Items</h2>
            <table id="table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Prority</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="container" style="margin-top:5%;">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Add Item</button>
            <div class="modal fade" id="myModal" role="dialog">
                <div class="modal-dialog">

                    <!-- Modal content-->
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">Add Item</h4>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <input class="form-control" type="text" id='item' placeholder="Item" required><br>
                                <input class="form-control" type="number" id="quantity" placeholder="Quantity" required><br>
                                <select id="priority" class="form-control">
                                    <option value="1">1 (Not Priority)</option>
                                    <option value="2">2 (Less Priority)</option>
                                    <option value="3">3 (Most Priority)</option>
                                </select>

                            </form>
                        </div>
                        <div class="modal-footer" id="buttons">
                            <button id="add" type="button" class="btn btn-info btn-lg">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="display:none;width : 400px;" id="updateForm" class="card bg-secondary container modal">
            <div class="card-header text-white">Update Item</div>
            <div class="card-body text-center">
                <form action="" class="form was-validated"> <input type="text" class="form-control" name="itemUpdate"
                        placeholder="Name" required autofocus><br> <input type="number" class="form-control" name="quantityUpdate"
                        placeholder="Quantity" min="1" required><br> <input type="number" class="form-control" name="priorityUpdate"
                        placeholder="Priority" min="1" max="3" required> </form>
            </div>
            <div class="card-footer"> <button id="updateItem" class="btn btn-success">UPDATE</button> <button id="updateCancel"
                    class="btn btn-danger">CANCEL</button> </div>
        </div>

    </center>


    <script>
        $(document).ready(function () {
            // events
            retrieveAll()
            $('#add').click(function (e) {
                if ($('#item').val() === "" || $('#quantity').val() === "") {
                    alert("Complete the fields!")
                } else {
                    e.preventDefault();
                    var items = {
                        item: $('#item').val(),
                        quantity: $('#quantity').val(),
                        priority: $('#priority').val(),
                    }

                    console.log(items)
                    $.ajax({
                        url: 'http://localhost:8081/item/create',
                        type: 'POST',
                        dataType: 'JSON',
                        data: items,
                        error: (e) => {
                            console.log(e)
                        },
                        success: function (res) {
                            addRows(res)
                        }
                    })
                }
            })

            $(document).on('click', ".action-btn", () => {
                var temp = $(this)[0].activeElement.id;
                var id = temp.split("_")
                if (id[0] == "update") {
                } else if (id[0] == "delete") {
                    deleteItem(id[1])
                    $("#" + temp).parent().parent().parent().fadeOut()
                }
            })
            // user defined functions
            function addRows(items) {
                var buttons = $("<div>").append(
                    $('<button>', {
                        id: "update_" + items._id,
                        class: "edit btn btn btn-info update-btn btn-sm action-btn",
                    }).text("update").css({
                        "border-radius": "40px",
                        marginLeft: "10px"
                    }),
                    $("<button>", {
                        id: "delete_" + items._id,
                        class: "btn btn-danger btn-sm delete-btn action-btn"
                    }).text("delete").css({
                        "border-radius": "40px",
                        marginLeft: "10px"
                    })
                )
                $('<tr>', {
                    id: items._id
                }).append(
                    $('<td>').text(items.item),
                    $('<td>').text(items.quantity),
                    $('<td>').text(items.priority),
                    $('<td>').append(buttons),
                ).appendTo('table tbody')
            }

            function retrieveAll() {
                $('tbody').empty()
                $.ajax({
                    url: "/item/retrieve/all",
                    type: "get",
                    error: function (e) {
                        console.error(e)
                    },
                    success: function (response) {
                        response.results.forEach(item => {
                            addRows(item)
                        });
                    }
                })
            }

            function updateItem(id) {
                $.ajax({
                    url: "/item/update/" + id,
                    type: "post",
                    error: (e) => {
                        console.error(e)
                    },
                    success: (res) => {
                        console.log(res)
                    }

                })
            }

            function deleteItem(id) {
                $.ajax({
                    url: "/item/delete/" + id,
                    type: "get",
                    error: (e) => {
                        console.error(e)
                    },
                    success: (res) => {
                        console.log(res)
                    }
                })
            }

            var updateId;
            $(document).on("click", ".edit", function () { 
                status = false;
                updateId = $(this).updateId;
                $("#updateForm").show();
            })

            $(document).on("click", "#updateItem", function () {
                updateItem(updateId);
                $("#updateForm").hide();
            })

            $("#updateCancel").on('click', function (e) {
                e.preventDefault();
                $("#updateForm").hide();
                $("#showTable").show();
            })

        })
    </script>
</body>

</html>